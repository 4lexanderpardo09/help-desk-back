{
    "info": {
        "_postman_id": "help-desk-api-v1",
        "name": "Help Desk API",
        "description": "API REST del sistema Help Desk - Backend NestJS\n\n## Autenticación\nUsa JWT Bearer Token. Primero ejecuta el endpoint de login y copia el token en la variable `token`.\n\n## Variables\n- `base_url`: URL base del API (default: http://localhost:3000)\n- `token`: Token JWT obtenido del login",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "variable": [
        {
            "key": "base_url",
            "value": "http://localhost:3000",
            "type": "string"
        },
        {
            "key": "token",
            "value": "",
            "type": "string"
        }
    ],
    "item": [
        {
            "name": "Auth",
            "description": "Endpoints de autenticación",
            "item": [
                {
                    "name": "Login",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('Login exitoso', function () {",
                                    "    pm.response.to.have.status(201);",
                                    "});",
                                    "",
                                    "pm.test('Respuesta contiene accessToken', function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData).to.have.property('accessToken');",
                                    "});",
                                    "",
                                    "// Guardar token automáticamente",
                                    "if (pm.response.code === 201) {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.collectionVariables.set('token', jsonData.accessToken);",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"email\": \"soportemesaayuda@gmail.com\",\n    \"password\": \"123456\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/auth/login",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "auth",
                                "login"
                            ]
                        },
                        "description": "Autentica un usuario y retorna un token JWT.\n\n**Payload del Token:**\n- `usu_id`: ID del usuario\n- `usu_correo`: Email del usuario\n- `rol_id`: ID del rol\n- `reg_id`: ID de la regional\n- `car_id`: ID del cargo\n- `dp_id`: ID del departamento\n- `es_nacional`: Boolean si es usuario nacional"
                    },
                    "response": []
                },
                {
                    "name": "Login - Credenciales inválidas",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('Retorna 401 Unauthorized', function () {",
                                    "    pm.response.to.have.status(401);",
                                    "});",
                                    "",
                                    "pm.test('Mensaje de error correcto', function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.message).to.eql('Credenciales inválidas');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"email\": \"usuario@invalido.com\",\n    \"password\": \"wrongpassword\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/auth/login",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "auth",
                                "login"
                            ]
                        },
                        "description": "Test de login con credenciales inválidas - debe retornar 401"
                    },
                    "response": []
                },
                {
                    "name": "Get Profile",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('Perfil obtenido correctamente', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "pm.test('Respuesta contiene datos del usuario', function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData).to.have.property('usu_id');",
                                    "    pm.expect(jsonData).to.have.property('usu_correo');",
                                    "    pm.expect(jsonData).to.have.property('rol_id');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/auth/profile",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "auth",
                                "profile"
                            ]
                        },
                        "description": "Obtiene el perfil del usuario autenticado basado en el token JWT.\n\n**Requiere:** Token JWT válido"
                    },
                    "response": []
                }
            ]
        },
        {
            "name": "Users",
            "description": "Gestión de usuarios (requiere autenticación)",
            "item": [
                {
                    "name": "Get All Users",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('Lista de usuarios obtenida', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "pm.test('Respuesta es un array', function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData).to.be.an('array');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users"
                            ]
                        },
                        "description": "Obtiene todos los usuarios activos del sistema.\n\n**Requiere:** Token JWT válido"
                    },
                    "response": []
                },
                {
                    "name": "Get User by ID",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('Usuario obtenido correctamente', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users/1",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "1"
                            ]
                        },
                        "description": "Obtiene un usuario específico por su ID.\n\n**Requiere:** Token JWT válido"
                    },
                    "response": []
                },
                {
                    "name": "Get Users by Departamento",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('Usuarios del departamento obtenidos', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "pm.test('Respuesta es un array', function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData).to.be.an('array');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users/departamento/1",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "departamento",
                                "1"
                            ]
                        },
                        "description": "Obtiene todos los usuarios de un departamento específico.\n\n**Requiere:** Token JWT válido"
                    },
                    "response": []
                },
                {
                    "name": "Get User by Email",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('Usuario obtenido por email', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users/email/soportemesaayuda@gmail.com",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "email",
                                "soportemesaayuda@gmail.com"
                            ]
                        },
                        "description": "Obtiene un usuario por su correo electrónico.\n\n**Requiere:** Token JWT válido"
                    },
                    "response": []
                },
                {
                    "name": "Create User",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('Usuario creado correctamente', function () {",
                                    "    pm.response.to.have.status(201);",
                                    "});",
                                    "",
                                    "pm.test('Respuesta contiene ID del usuario', function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData).to.have.property('id');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            },
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"nombre\": \"Nuevo\",\n    \"apellido\": \"Usuario\",\n    \"email\": \"nuevo.usuario@example.com\",\n    \"password\": \"123456\",\n    \"rolId\": 2,\n    \"esNacional\": false,\n    \"regionalId\": 1,\n    \"cargoId\": 1,\n    \"departamentoId\": null,\n    \"cedula\": \"1234567890\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/users",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users"
                            ]
                        },
                        "description": "Crea un nuevo usuario en el sistema.\n\n**Campos requeridos:**\n- nombre, apellido, email, password, rolId, esNacional\n\n**Campos opcionales:**\n- departamentoId, regionalId, cargoId, cedula\n\n**Requiere:** Token JWT válido"
                    },
                    "response": []
                },
                {
                    "name": "Update User",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('Usuario actualizado correctamente', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "pm.test('Respuesta contiene datos actualizados', function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData).to.have.property('id');",
                                    "    pm.expect(jsonData).to.have.property('fechaModificacion');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "PUT",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            },
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"nombre\": \"Nombre Actualizado\",\n    \"apellido\": \"Apellido Actualizado\",\n    \"rolId\": 2\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/users/1",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "1"
                            ]
                        },
                        "description": "Actualiza un usuario existente. Solo se actualizan los campos enviados.\n\n**Campos opcionales:**\n- nombre, apellido, email, password, rolId, departamentoId, regionalId, cargoId, esNacional, cedula\n\n**Nota:** Si se envía password, se hashea automáticamente.\n\n**Requiere:** Token JWT válido"
                    },
                    "response": []
                },
                {
                    "name": "Delete User (Soft Delete)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test('Usuario eliminado correctamente', function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "pm.test('Respuesta confirma eliminación', function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.deleted).to.be.true;",
                                    "    pm.expect(jsonData).to.have.property('id');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "DELETE",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users/1",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "1"
                            ]
                        },
                        "description": "Elimina un usuario (soft delete). No borra físicamente, solo marca:\n- `est = 0`\n- `fech_elim = NOW()`\n\n**Requiere:** Token JWT válido"
                    },
                    "response": []
                },
                {
                    "name": "Get Users Sin Departamento",
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users/sin-departamento",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "sin-departamento"
                            ]
                        },
                        "description": "Obtiene usuarios sin departamento asignado (dp_id IS NULL)."
                    },
                    "response": []
                },
                {
                    "name": "Get Users by Cargo",
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users/cargo/1",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "cargo",
                                "1"
                            ]
                        },
                        "description": "Obtiene usuarios por cargo con datos de regional."
                    },
                    "response": []
                },
                {
                    "name": "Get Users by Rol",
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users/rol/2",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "rol",
                                "2"
                            ]
                        },
                        "description": "Obtiene usuarios por rol (dinámico)."
                    },
                    "response": []
                },
                {
                    "name": "Get Agentes",
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users/agentes",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "agentes"
                            ]
                        },
                        "description": "Obtiene agentes (usuarios con rol_id=2). Equivalente a get_usuario_x_rol."
                    },
                    "response": []
                },
                {
                    "name": "Update Firma",
                    "request": {
                        "method": "PUT",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            },
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"firma\": \"path/to/firma.png\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/users/1/firma",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "1",
                                "firma"
                            ]
                        },
                        "description": "Actualiza la firma de un usuario."
                    },
                    "response": []
                },
                {
                    "name": "Get User with Empresas",
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users/1/with-empresas",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "1",
                                "with-empresas"
                            ]
                        },
                        "description": "Obtiene usuario por ID con empresas asociadas (GROUP_CONCAT de emp_ids)."
                    },
                    "response": []
                },
                {
                    "name": "Get User by Cargo and Regional",
                    "request": {
                        "method": "GET",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer {{token}}"
                            }
                        ],
                        "url": {
                            "raw": "{{base_url}}/users/cargo/1/regional/1",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "cargo",
                                "1",
                                "regional",
                                "1"
                            ]
                        },
                        "description": "Obtiene un usuario por cargo y regional (LIMIT 1)."
                    },
                    "response": []
                }
            ]
        }
    ]
}